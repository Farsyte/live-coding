     1     			title   'mds cold start loader at 3000h'
     2 			;
     3 			;	mds-800 cold start loader for cp/m 2.0
     4 			;
     5 			;	version 2.0 august, 1979
     6 			;
     7 			; modified slightly (October 2023) so "asm8080" can assemble it
     8 			;
     9      00 00	false	equ	0
    10      FF FF	true	equ	not false
    11      00 00	testing	equ	false    	;if true, then go to mon80 on  errors
    12 			;
    13     			if	testing
    14     		bias	equ	03400h
    15     			else
    16      00 00	bias	equ	0000h
    17     			endif
    18      00 00	cpmb	equ	bias		;base of dos load
    19      08 06	bdos	equ	806h+bias	;entry to dos for calls
    20      18 80	bdose	equ	1880h+bias	;end of dos load
    21      16 00	boot	equ	1600h+bias	;cold start entry point
    22      16 03	rboot	equ	boot+3		;warm start entry point
    23 			;
    24      30 00		org	03000h		;loaded here by hardware
    25 			;
    26      18 80	bdosl	equ	bdose-cpmb	;length of BDOS in bytes
    27      00 02	ntrks	equ	2		;number of tracks to read
    28      00 31	bdoss	equ	bdosl/128	;number of sectors in dos
    29      00 19	bdos0	equ	25		;number of bdos sectors on track 0
    30      00 18	bdos1	equ	bdoss-bdos0	;number of sectors on track 1
    31 			;
    32      F8 00	mon80	equ	0f800h		;intel monitor base
    33      FF 0F	rmon80	equ	0ff0fh		;restart location for mon80
    34      00 78	base	equ	078h		;'base' used by controller
    35      00 79	rtype	equ	base+1		;result type
    36      00 7B	rbyte	equ	base+3		;result byte
    37      00 7F	reset	equ	base+7		;reset controller
    38 			;
    39 			;
    40      00 78	dstat	equ	base		;disk status port
    41      00 79	ilow	equ	base+1		;low iopb address
    42      00 7A	ihigh	equ	base+2		;high iopb address
    43      00 FF	bsw	equ	0ffh		;boot switch
    44      00 03	recal	equ	3h		;recalibrate selected drive
    45      00 04	readf	equ	4h		;disk read function
    46      01 00	stack	equ	100h		;use end of boot for stack
    47 			;
    48 			rstart:
    49 3000 31 00 01		lxi	sp,stack;	;in case of call to mon80
    50 			;	clear disk status
    51 3003 DB 79		in	rtype
    52 3005 DB 7B		in	rbyte
    53 			;	check if boot switch is off
    54 			coldstart:
    55 3007 DB FF		in 	bsw
    56 3009 E6 02		ani	02h		;switch on?
    57 300B C2 07 30		jnz	coldstart
    58 			;	clear the controller
    59 300E D3 7F		out	reset		;logic cleared
    60 			;
    61 			;
    62 3010 06 02		mvi	b,ntrks		;number of tracks to read
    63 3012 21 42 30		lxi	h,iopb0
    64 			;
    65 			start:
    66 			;
    67 			;	read first/next track into cpmb
    68 3015 7D			mov	a,l
    69 3016 D3 79		out	ilow
    70 3018 7C			mov	a,h
    71 3019 D3 7A		out	ihigh
    72 301B DB 78	wait0:	in	dstat
    73 301D E6 04		ani	4
    74 301F CA 1B 30		jz	wait0
    75 			;
    76 			;	check	disk status
    77 3022 DB 79		in	rtype
    78 3024 E6 03		ani	11b
    79 3026 FE 02		cpi	2
    80 			;
    81     			if	testing
    82     			cnc	rmon80		;go to monitor if 11 or 10
    83     		        else
    84 3028 D2 00 30		jnc	rstart		;retry the load
    85     			endif
    86 			;
    87 302B DB 7B		in	rbyte		;i/o complete, check status
    88 			;	if not	ready, then go to mon80
    89 302D 17			ral
    90 302E DC 0F FF		cc	rmon80		;not ready bit set
    91 3031 1F			rar			;restore
    92 3032 E6 1E		ani	11110b		;overrun/addr err/seek/crc/xxxx
    93 			;
    94     			if	testing
    95     			cnz	rmon80		;go to monitor
    96     		        else
    97 3034 C2 00 30		jnz	rstart		;retry the load
    98     			endif
    99 			;
   100 			;
   101 3037 11 07 00		lxi	d,iopbl		;length of iopb
   102 303A 19			dad	d		;addressing next iopb
   103 303B 05			dcr	b		;count down tracks
   104 303C C2 15 30		jnz	start
   105 			;
   106 			;
   107 			;	jmp to boot to print initial message, and set up jmps
   108 303F C3 00 16		jmp	boot
   109 			;
   110 			;	parameter blocks
   111 3042		iopb0:	db	80h		;iocw, no update
            80 
   112 3043			db	readf		;read function
            04 
   113 3044			db	bdos0		;*sectors to read on track 0
            19 
   114 3045			db	0		;track 0
            00 
   115 3046			db	2		;start with sector 2 on track 0
            02 
   116 3047			dw	cpmb		;start at base of bdos
            0000 
   117      00 07	iopbl	equ	$-iopb0
   118 			;
   119 3049		iopb1:	db	80h
            80 
   120 304A			db	readf
            04 
   121 304B			db	bdos1		;sectors to read on track 1
            18 
   122 304C			db	1		;track 1
            01 
   123 304D			db	1		;sector 1
            01 
   124 304E			dw	cpmb+bdos0*128	;base of second read
            800C 
   125 			;
   126     			end


*******************************************************************************
                                 Symbols table
*******************************************************************************

Names		Types	Values
-----		-----	------
false		EQU	00000h
true		EQU	FFFFFFFFh
testing		EQU	00000h
bias		EQU	00000h
cpmb		EQU	00000h
bdos		EQU	00806h
bdose		EQU	01880h
boot		EQU	01600h
rboot		EQU	01603h
bdosl		EQU	01880h
ntrks		EQU	00002h
bdoss		EQU	00031h
bdos0		EQU	00019h
bdos1		EQU	00018h
mon80		EQU	0F800h
rmon80		EQU	0FF0Fh
base		EQU	00078h
rtype		EQU	00079h
rbyte		EQU	0007Bh
reset		EQU	0007Fh
dstat		EQU	00078h
ilow		EQU	00079h
ihigh		EQU	0007Ah
bsw		EQU	000FFh
recal		EQU	00003h
readf		EQU	00004h
stack		EQU	00100h
iopbl		EQU	00007h
rstart		Label	03000h
coldstart	Label	03007h
start		Label	03015h
wait0		Label	0301Bh
iopb0		Label	03042h
iopb1		Label	03049h

Statistics
----------
"Name"	= 0
"EQU"	= 28
"SET"	= 0
Labels	= 6


