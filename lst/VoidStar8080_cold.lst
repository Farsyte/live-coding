     1     			TITLE	'Cold Start Loader for the (void *)8080 simulated microcomputer'
     2
     3 				;; This cold start loader resides on Track 0 Sector 1 (the
     4 				;; first sector of the diskette). This is loaded into memory
     5 				;; upon system start-up. The cold start loader brings the CP/M
     6 				;; system into memory at "loadp" (3400h+b), where b=0 for 20
     7 				;; KiB systems, then increases with the memory size. after
     8 				;; loading the CP/M system, the cold start loader branches to
     9 				;; the bios at "3E00h+b". The cold start loader is not used
    10 				;; until the system is powered up again, as long as the bios
    11 				;; is not overwritten. the origin is assumed at 0000h, and
    12 				;; must be changed if the controller brings the cold start
    13 				;; loader into another area, or if a read/only memory area is
    14 				;; used.
    15
    16      00 00		org	0		;base of memory
    17
    18      00 14	msize	equ	20		;min mem size in kbytes
    19
    20      00 00	bias	equ	(msize-20)*1024 ;offset from 20k system
    21      34 00	ccp	equ	3400h+bias	;base of the ccp
    22      4A 00	bios	equ	ccp+1600h	;base of the bios
    23      03 00	biosl	equ	0300h		;length of the bios
    24      4A 00	boot	equ	bios
    25      4D 00	biose   equ     bios+biosl
    26      19 00	size	equ	biose-ccp	;size of cp/m system
    27      00 1A	spt	equ     26
    28      00 80	sectsz  equ     128
    29      00 32	sects	equ	size/sectsz	;# of sectors to load
    30
    31 			;;; === === === === === === === === === === === === === === === ===
    32 			;;; disk controller i/o ports
    33 			;;; === === === === === === === === === === === === === === === ===
    34
    35      00 0A	bdres	equ	10              ;reset controller (drv 0, trk 0, sec 1)
    36      00 0B	bddrv	equ	11              ;select drive
    37      00 0C	bdtrk	equ	12              ;select track
    38      00 0D	bdsec	equ	13              ;select sector
    39      00 0E	bddat	equ	14              ;read/write next byte
    40
    41 			; begin the load operations
    42
    43 			        ;; register usage:
    44 			        ;;      b       track 0..1
    45 			        ;;      c       sector 1..26
    46 			        ;;      d       sectors remaining to load (50->0)
    47 			        ;;      e       bytes remaining to load (128->0)
    48 			        ;;      hl      load address (3400H+b->4D00H+b)
    49
    50 			cold:
    51 0000 01 02 00		lxi	bc,2		;select b=track 0, c=sector 2
    52 0003 16 32		mvi	d,sects		;set up d = number of sectors to load
    53 0005 21 00 34		lxi	h,ccp		;load point in h,l
    54
    55 0008 DB 0B	        in      bddrv           ;persist selected disk
    56 000A D3 0A	        out     bdres           ;reset bdev controller
    57 000C D3 0B	        out     bddrv           ;reselect desired disk
    58 			read:   
    59 000E 78		        mov     a,b 
    60 000F D3 0C	        out     bdtrk           ;select track
    61 0011 79		        mov     a,c
    62 0012 D3 0D	        out     bdsec           ;select sector
    63 0014 1E 80	        mvi     e,sectsz
    64 			readl:                          ;this system uses PIO to move disk data.
    65 0016 DB 0E	        in      bddat           ;get byte from disk
    66 0018 77		        mov     m,a             ;store to memory.
    67 0019 23		        inx     hl
    68 001A 1D		        dcr     e
    69 001B C2 16 00	        jnz     readl
    70
    71 			; go to next sector if load is incomplete
    72 001E 15			dcr	d		;sects=sects-1
    73 001F CA 00 4A		jz	boot+bias	;done, go to boot loader at 3e00h+bias
    74 			;
    75 			; more sectors to load
    76 0022 0C			inr	c		;sector=sector+1
    77 0023 79			mov	a,c		;move sector count to a for compare
    78 0024 FE 1B		cpi	spt+1		;last sector of track?
    79 0026 DA 0E 00		jc	read		;no, go read another
    80 			;
    81 			; end of track, move to next track
    82 0029 0E 01		mvi	c,1		;sector=1
    83 002B 04			inr	b		;track=track+1
    84 002C C3 0E 00		jmp	read		;for another sector
    85 			;
    86     			end


*******************************************************************************
                                 Symbols table
*******************************************************************************

Names		Types	Values
-----		-----	------
msize		EQU	00014h
bias		EQU	00000h
ccp		EQU	03400h
bios		EQU	04A00h
biosl		EQU	00300h
boot		EQU	04A00h
biose		EQU	04D00h
size		EQU	01900h
spt		EQU	0001Ah
sectsz		EQU	00080h
sects		EQU	00032h
bdres		EQU	0000Ah
bddrv		EQU	0000Bh
bdtrk		EQU	0000Ch
bdsec		EQU	0000Dh
bddat		EQU	0000Eh
cold		Label	00000h
read		Label	0000Eh
readl		Label	00016h

Statistics
----------
"Name"	= 0
"EQU"	= 16
"SET"	= 0
Labels	= 3


