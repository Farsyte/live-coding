     1     		        TITLE   'cold start loader'
     2
     3      00 00	        ORG     00000H          ;BASE OF MEMORY
     4      00 10	MSIZE   EQU     16              ;MEMORY SIZE IN KILOBYTES
     5      00 00	BIAS    EQU     (MSIZE-16)*1024 ;BIAS TO ADD TO LOAD ADDRESSES
     6      29 00	LOADP   EQU     2900H           ;LOAD POINT FOR CP/M SYSTEM
     7      3E 00	BIOS    EQU     3E00H           ;BASIC I/O SYSTEM (2 PAGES = 512 BYTES)
     8      3E 00	BOOT    EQU     BIOS            ;COLD START ENTRY POINT IN BIOS
     9      17 00	SIZE    EQU     BIOS+512-LOADP  ;SIZE OF THE CP/M SYSTEM TO LOAD
    10      00 2E	SECTS   EQU     SIZE/128        ;NUMBER OF SECTORS TO LOAD
    11 			;
    12 			; BEGIN THE LOAD OPERATIONS
    13 0000 01 02 00	COLD:   LXI	B,2             ;CLEAR B TO 0, SET C TO SECTOR 2
    14 0003 16 2E	        MVI     D,SECTS         ;NUMBER OF SECTORS TO LOAD IS IN D
    15 0005 21 00 29	        LXI     H,LOADP+BIAS    ;LOAD POINT IN H,L
    16 			;
    17 			LSECT:  ;LOAD NEXT SECTOR
    18 			; INSERT INLINE CODE AT THIS POINT TO READ ONE 128 BYTE SECTOR
    19 			; FROM TRACK GIVEN BY REGISTER B,
    20 			;     SECTOR GIVEN BY REGISTER C,
    21 			; INTO ADDRESS GIVEN BY REGISTER PAIR H,L
    22 			; BRANCH TO LOCATION 'COLD' IF A READ ERROR OCCURS
    23 			;
    24 			; ****************************************************************
    25 			; USER SUPPLIED READ OPERATION GOES HERE
    26 			; ****************************************************************
    27 			; (SPACE IS RESERVED FOR YOUR PATCH)
    28 0008 C3 6B 00		JMP	PASTPATCH	;REMOVE THIS JUMP WHEN PATCHED
    29 000B		        DS      60H
    30 			;
    31 			PASTPATCH:
    32 			; GO TO NEXT SECTOR IF LOAD IS INCOMPLETE
    33 006B 15			DCR	D		;SECTS=SECTS-1
    34 006C CA 00 3E	        JZ      BOOT+BIAS       ;GO TO BOOT LOADER AT 3E00H+BIAS
    35 			;
    36 			; MORE SECTORS TO LOAD
    37 			; USE SP FOR SCRATCH REGISTER TO HOLD LOAD ADDRESS INCREMENT
    38 006F 31 80 00		LXI	SP,128
    39 0072 39		        DAD     SP              ;HL=HL+128 TO NEXT LOAD ADDRESS
    40 0073 0C		        INR     C               ;SECTOR=SECTOR+1
    41 0074 79		        MOV     A,C             ;MOVE SECTOR COUNT TO A FOR COMPARE
    42 0075 FE 1B	        CPI     27              ;END OF CURRENT TRACK?
    43 0077 DA 08 00	        JC      LSECT           ;CARRY GENERATED IF SECTOR < 27
    44 			;
    45 			; END OF TRACK, MOVE TO NEXT TRACK
    46 007A 0E 01		MVI	C,1		;SECTOR=1
    47 007C 04		        INR     B               ;TRACK=TRACK+1
    48 007D C3 08 00	        JMP     LSECT           ;FOR ANOTHER SECTOR
    49 			;
    50     		        END


*******************************************************************************
                                 Symbols table
*******************************************************************************

Names		Types	Values
-----		-----	------
MSIZE		EQU	00010h
BIAS		EQU	00000h
LOADP		EQU	02900h
BIOS		EQU	03E00h
BOOT		EQU	03E00h
SIZE		EQU	01700h
SECTS		EQU	0002Eh
COLD		Label	00000h
LSECT		Label	00008h
PASTPATCH	Label	0006Bh

Statistics
----------
"Name"	= 0
"EQU"	= 7
"SET"	= 0
Labels	= 3


